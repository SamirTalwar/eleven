#!/usr/bin/env zsh

set -e
set -u
set -o pipefail

test_script=$(mktemp)
pid_file=$(mktemp)
pid=''

cat > $test_script
chmod +x $test_script

function set_up {
  ./app --detach --pid-file=$pid_file $1
  pid=$(<$pid_file)
}

function run_test {
  sleep 1
  $test_script
}

function tear_down {
  if app_is_alive; then
    kill $pid
    for i in {1..20}; do
      app_is_alive || break
      sleep 0.1
    done
    if app_is_alive; then
      echo >&2 "The application (PID ${pid}) has not terminated. Better investigate."
    fi
  fi
  rm -f $test_script
}

function app_is_alive {
  [[ -n $pid ]] && kill -0 $pid >& /dev/null
}

trap tear_down EXIT
set_up $1
run_test
